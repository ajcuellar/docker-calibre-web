#!/usr/bin/bash
# create symlinks for imagemagick policy.xml
rm -rf /etc/ImageMagick-6/policy.xml
ln -s /defaults/policy.xml /etc/ImageMagick-6/policy.xml

# create Google drive client_secrets.json file
if [[ ! -f /config/client_secrets.json ]]; then
    echo '{}' > /config/client_secrets.json
fi

# check if kepubify is present and if so make executable
if [[ -f /usr/bin/kepubify ]] && [[ ! -x /usr/bin/kepubify ]]; then
    chmod +x /usr/bin/kepubify
fi

# Pre-stage some files & directories for permissions purposes
mkdir -p /app/calibre-web/cps/cache

# Initialize statistics cache if it doesn't exist
echo "Checking statistics cache..."
if [[ ! -f /config/admin_stats_cache.json ]]; then
    echo "Initializing statistics cache (first run)..."
    cd /app/calibre-web && /lsiopy/bin/python cps/init_stats.py || echo "Statistics cache will be created on first access"
fi